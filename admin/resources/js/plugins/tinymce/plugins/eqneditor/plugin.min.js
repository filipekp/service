/* 
 Equation Editor Plugin for TinyMCE v4
 Version 2

 This plugin allows equations to be created and edited from within TinyMCE.
 For more information goto: http://www.codecogs.com/latex/integration/tinymce_v4/install.php
 
 Copyright CodeCogs 2013
 Written by Will Bateman.
*/
CCinstance=0;
tinymce.PluginManager.add("eqneditor",function(editor, url) {

	// Load necessary javscript for editor from CodeCogs
	var sl = new tinymce.dom.ScriptLoader();	
var host='latex.codecogs.com';
  var lastElement = null;
		
	var http=('https:' == document.location.protocol ? 'https://' : 'http://');
	sl.add(tinymce.baseURL + '/plugins/eqneditor/eq_config.js');
	sl.add(tinymce.baseURL + '/plugins/eqneditor/eq_editor-lite-17.js');
	sl.loadQueue(function(){});

	// Load Additional CSS 
	var fileref=document.createElement("link");
	fileref.setAttribute("rel", "stylesheet");
	fileref.setAttribute("type", "text/css");
	fileref.setAttribute("href", http+host+'/css/equation-embed.css');
	document.getElementsByTagName("head")[0].appendChild(fileref);
  
  function setCursorPosition (editor, index) {
    var content = editor.getContent();

    var part1 = content.substr(0, index);
    var part2 = content.substr(index);

    var bookmark = editor.selection.getBookmark(0);

    var positionString = '<span id="'+bookmark.id+'_start" data-mce-type="bookmark" data-mce-style="overflow:hidden;line-height:0px"></span>';
    var contentWithString = part1 + positionString + part2;

    editor.setContent(contentWithString);

    editor.selection.moveToBookmark(bookmark);

    //return bookmark;
  }
  
  function getCursorPosition(editor) {
    var bm = editor.selection.getBookmark(0);    

    var selector = "[data-mce-type=bookmark]";
    var bmElements = editor.dom.select(selector);

    editor.selection.select(bmElements[0]);
    editor.selection.collapse();

    var elementID = "######cursor######";
    var positionString = '<span id="'+elementID+'"></span>';
    editor.selection.setContent(positionString);

    var content = editor.getContent({format: "html"});
    var index = content.indexOf(positionString);

    editor.dom.remove(elementID, false);            

    editor.selection.moveToBookmark(bm);

    return index;
  }

	function showDialog() {
		var http = ('https:' == document.location.protocol ? 'https://' : 'http://');

		CCinstance++;
		win = editor.windowManager.open({
			title: 'Editor rovnic',
			width: 615,
			height: 380,
			items: [
				{
						name:'toolbar',
						type:'container',
						html:'<div style="padding:10px;"><div id="CCtoolbar'+CCinstance+'"></div>'+
								 '<p style="margin-top:5px"><label for="CClatex'+CCinstance+'">Zápis v (LaTeX):</p>'+
								 '<textarea id="CClatex'+CCinstance+'" rows="5" style="border:1px solid #8fb6bd; width:570px; font-size:16px; padding:5px; background-color:#ffc"></textarea>'+
								 '<p style="margin-top:5px"><label for="CClatex'+CCinstance+'">Zobrazení výsledku:</p>'+
								 '<img id="CCequation'+CCinstance+'" src="'+http+'www.codecogs.com/images/spacer.gif" /></div>'
				}
			],
			buttons : [
					{
						type:'container',
						html: '<span style="font-size:11px;"><a href="http://www.codecogs.com" target="_blank" style="font-size:11px"><img src="'+http+'latex.codecogs.com/images/poweredbycc.gif" width="105" height="35" border="0" alt="Powered by CodeCogs" style="vertical-align:-7px"/></a> upravil: <a href="http://filipek-czech.cz" target="_blank" style="font-size:11px">Pavel Filípek</a></span>'//'<span style="font-size:11px;"><a href="http://www.codecogs.com" target="_blank" style="font-size:11px"><img src="'+http+'latex.codecogs.com/images/poweredbycc.gif" width="105" height="35" border="0" alt="Powered by CodeCogs" style="vertical-align:-7px"/></a> &nbsp; <a href="http://www.codecogs.com/latex/about.php" target="_blank"  style="font-size:11px">About</a> | <a href="http://www.codecogs.com/latex/popup.php" target="_blank" style="font-size:11px">Install</a> | <a href="http://www.codecogs.com/pages/forums/forum_view.php?f=28" target="_blank" style="font-size:11px">Forum</a> | <a href="http://www.codecogs.com" target="_blank" style="font-size:11px">CodeCogs</a> &copy; 2007-2013</span>'
					},
					{type: "spacer", flex: 1},
					{
						text: 'Ok',
						subtype: 'primary',
						minWidth: 50,
						onclick: function() {
              var newSpanHtml = EqEditor.getTextArea().exportEquation('latex');
              
							editor.execCommand('mceInsertContent', false, newSpanHtml);
							Example.add_history(EqEditor.getTextArea().getLaTeX());
              
              var html = newSpanHtml.replace(/\\/g, '\\\\')
                                    .replace(/\$/g, '\\$')
                                    .replace(/\{/g, '\\{')
                                    .replace(/\}/g, '\\}')
                                    .replace(/\[/g, '\\[')
                                    .replace(/\]/g, '\\]')
                                    .replace(/\(/g, '\\(')
                                    .replace(/\)/g, '\\)')
                                    .replace(/\./g, '\\.');              
              var regex1 = new RegExp('(.*)(' + html + ')(&nbsp;)*(.*)', 'g');
              var regex2 = new RegExp('(.*)(' + html + ')( )*(.*)', 'g');
              editor.setContent(editor.getContent().replace(regex1, '$1$2$4'));
              editor.setContent(editor.getContent().replace(regex2, '$1$2$4'));
              
              setCursorPosition(editor, editor.getContent().indexOf(newSpanHtml) + newSpanHtml.length);
              editor.execCommand('mceInsertContent', false, '&nbsp;');
              
              lastElement = null;
							win.close();
						}
					},
					{
						text: 'Zrušit', 
						onclick: function() {
              if (lastElement) {
                editor.execCommand('mceInsertContent', false, lastElement.wrap('<div />').parent().html());
                setCursorPosition(editor, getCursorPosition(editor) + '&nbsp;'.length);
                lastElement = null;
              }
              
              win.close();
            }
					}
			]
		});
		
		EqEditor.embed('CCtoolbar'+CCinstance,'','efull');
 		EqEditor.add(new EqTextArea('CCequation'+CCinstance, 'CClatex'+CCinstance),false);

		var $element = $(editor.selection.getNode());
		if ($element.is('span')) {
			EqEditor.getTextArea().setText($element.text().replace(/^\$(.*)\$$/, '$1'));
      lastElement = $element.clone(true);
      $element.remove();
		}
	}
	
	
  editor.addButton('eqneditor', {
			title: 'Editor rovnic',
			image: url+'/img/eqneditor.png',
			tooltip: 'Vložit rovnici',
			onclick: showDialog,
			stateSelector: 'img[src*="latex"]'
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('eqneditor', {
			image: url+'/img/eqneditor.png',
			text: 'Vložit rovnici',
			context: 'insert',
			prependToContext:true,
			onclick: showDialog
	}); 
	
	editor.on('DblClick', function(ed, e) {
		if (ed.target.nodeName.toLowerCase() === "span") {
			if($(ed.target).is('.latex-string')) showDialog();
      $('.mce-close').remove();
		}
	});
	
});
